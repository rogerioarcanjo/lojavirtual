@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject CustomAuthenticationStateProvider CustomAuthStateProvider
@if (usuario != null)
{
     <AuthorizeView>
            <Authorized>
                  <a href="Login" class="btn btn-info">
                    <i class="oi oi-person"></i>Olá, @usuario?.FirstOrDefault()?.Value
                    <span class="badge bg-dark"></span>
                  </a>
            </Authorized>
            <NotAuthorized>
                <!-- Se não estiver autenticado, não exibir nada aqui -->
            </NotAuthorized>
        </AuthorizeView>
}
else
{
    <a href="Login" class="btn btn-info">
        <i class="oi oi-person"></i>&nbsp;Faça o login
        <span class="badge bg-dark"></span>
    </a>
}

@code {
    private IEnumerable<Claim>? usuario;
    private string? userName;


    protected override async Task OnInitializedAsync()
    {
        // Inicializa o userName com o estado de autenticação atual
        await UpdateUserName();
    }

    private async Task UpdateUserName()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        usuario = user.Claims;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            
            userName = user.FindFirst(ClaimTypes.Name)?.Value
                       ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                       ?? user.Identity?.Name;
        }
        else
        {
            userName = null;
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await UpdateUserName();
        await InvokeAsync(StateHasChanged);
    }

    private async Task Logout()
    {
        await CustomAuthStateProvider.MarkUserAsLoggedOut();
        Navigation.NavigateTo("/login");
    }
}